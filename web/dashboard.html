<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>csesh</title>
<script src="/vendor/chart.js"></script>
<script src="/vendor/marked.js"></script>
<script src="/vendor/purify.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg-0:#09090b;--bg-1:#111113;--bg-2:#18181b;--bg-3:#1f1f23;--bg-4:#27272a;
  --border:#27272a;--border-subtle:#1e1e21;
  --text-1:#fafafa;--text-2:#a1a1aa;--text-3:#71717a;
  --accent:#3b82f6;--accent-h:#2563eb;--accent-bg:rgba(59,130,246,.1);
  --green:#22c55e;--green-bg:rgba(34,197,94,.1);
  --yellow:#f59e0b;--yellow-bg:rgba(245,158,11,.1);
  --red:#ef4444;--red-bg:rgba(239,68,68,.1);
  --blue:#06b6d4;--purple:#a855f7;
  --font:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;--mono:ui-monospace,SFMono-Regular,'SF Mono',Menlo,Consolas,monospace;
  --radius:6px;
  --chart-grid:#1e1e21;
  --shadow-modal:rgba(0,0,0,.6);--shadow-card:rgba(0,0,0,.3);--shadow-bar:rgba(0,0,0,.4);
  --heatmap-0:var(--bg-2);--heatmap-1:rgba(59,130,246,.25);--heatmap-2:rgba(59,130,246,.5);--heatmap-3:rgba(59,130,246,.75);--heatmap-4:var(--accent);
}
[data-theme="light"]{
  --bg-0:#f8f9fa;--bg-1:#ffffff;--bg-2:#f0f1f3;--bg-3:#e4e5e9;--bg-4:#d1d5db;
  --border:#d1d5db;--border-subtle:#e5e7eb;
  --text-1:#111827;--text-2:#4b5563;--text-3:#9ca3af;
  --accent:#2563eb;--accent-h:#1d4ed8;--accent-bg:rgba(37,99,235,.08);
  --green:#16a34a;--green-bg:rgba(22,163,74,.08);
  --yellow:#d97706;--yellow-bg:rgba(217,119,6,.08);
  --red:#dc2626;--red-bg:rgba(220,38,38,.08);
  --blue:#0891b2;--purple:#9333ea;
  --chart-grid:#e5e7eb;
  --shadow-modal:rgba(0,0,0,.25);--shadow-card:rgba(0,0,0,.08);--shadow-bar:rgba(0,0,0,.12);
  --heatmap-0:#ebedf0;--heatmap-1:rgba(37,99,235,.2);--heatmap-2:rgba(37,99,235,.45);--heatmap-3:rgba(37,99,235,.7);--heatmap-4:var(--accent);
}
html{font-size:14px}
body{font-family:var(--font);background:var(--bg-0);color:var(--text-1);display:flex;min-height:100vh;line-height:1.5}
a{color:var(--accent);text-decoration:none}
button{font-family:var(--font);cursor:pointer}
input,textarea,select{font-family:var(--font);background:var(--bg-2);color:var(--text-1);border:1px solid var(--border);border-radius:var(--radius);padding:6px 10px;outline:none;font-size:.875rem}
input:focus,textarea:focus{border-color:var(--accent)}

/* Sidebar */
#sidebar{width:272px;min-width:272px;background:var(--bg-1);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:width .2s,min-width .2s;height:100vh;position:sticky;top:0}
#sidebar.collapsed{width:48px;min-width:48px}
#sidebar.collapsed .sb-section,#sidebar.collapsed .sb-search,#sidebar.collapsed .sb-tiers{display:none}
#sidebar.collapsed .sb-footer .sb-footer-row,#sidebar.collapsed .sb-footer .sb-footer-actions{display:none}
#sidebar.collapsed .sb-header h1 .sb-name{display:none}
.sb-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sb-header h1{font-size:1rem;font-weight:700;display:flex;align-items:center;gap:8px}
.sb-header h1 span{color:var(--accent)}
.sb-toggle{background:none;border:none;color:var(--text-3);cursor:pointer;padding:2px 4px;font-size:.8rem;transition:color .15s;flex-shrink:0}
.sb-toggle:hover{color:var(--text-1)}
.sb-search{padding:8px 12px}
.sb-search input{width:100%;padding:7px 10px 7px 38px;background:var(--bg-2);font-size:.8rem;border-radius:var(--radius)}
.sb-search-wrap{position:relative}
.sb-search-wrap::before{content:'⌘↵';position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--text-3);font-size:.65rem;font-family:var(--mono);background:var(--bg-3);border-radius:3px;padding:0 4px;line-height:1.4}
.sb-section{padding:4px 8px;flex:1;min-height:0;overflow-y:auto}
.sb-section-title{font-size:.7rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-3);padding:8px 8px 4px;font-weight:600}
.sb-list{list-style:none}
.sb-item{padding:5px 10px;border-radius:var(--radius);cursor:pointer;font-size:.8rem;display:flex;justify-content:space-between;align-items:center;color:var(--text-2);transition:background .1s}
.sb-item:hover{background:var(--bg-3);color:var(--text-1)}
.sb-item.active{background:var(--accent-bg);color:var(--accent)}
.sb-badge{font-size:.7rem;background:var(--bg-3);border-radius:10px;padding:1px 7px;color:var(--text-3);font-weight:500}
.sb-item.active .sb-badge{background:rgba(59,130,246,.15);color:var(--accent)}
.sb-tiers{padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0}
.tier-row{display:flex;justify-content:space-between;font-size:.75rem;color:var(--text-2);padding:2px 0}
.tier-row .dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.sb-footer{padding:8px 16px;border-top:1px solid var(--border);font-size:.7rem;color:var(--text-3);flex-shrink:0}
.sb-footer-row{display:flex;align-items:center;justify-content:space-between}
.sb-footer-actions{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:4px}
.sb-footer-actions button,.sb-footer-actions a,.sb-footer-actions span{background:none;border:none;color:var(--text-3);cursor:pointer;padding:2px;display:flex;align-items:center;transition:color .15s;font-size:.8rem;line-height:1}
.sb-footer-actions button:hover,.sb-footer-actions a:hover,.sb-footer-actions span:hover{color:var(--accent)}
.sb-footer .info-btn{background:none;border:none;color:var(--text-3);cursor:pointer;padding:2px;display:flex;align-items:center;transition:color .15s}
.sb-footer .info-btn:hover{color:var(--accent)}
#infoModal{position:fixed;inset:0;background:var(--shadow-modal);z-index:300;display:none;align-items:center;justify-content:center}
#infoModal .modal{background:var(--bg-1);border:1px solid var(--border);border-radius:12px;padding:28px;max-width:380px;width:90%;text-align:center}
#infoModal .modal h3{font-size:1rem;margin-bottom:4px;font-weight:700}
#infoModal .modal .subtitle{font-size:.78rem;color:var(--text-3);margin-bottom:16px}
.info-author{font-size:.85rem;font-weight:600;color:var(--text-1);margin-bottom:2px}
.info-handle{font-size:.78rem;color:var(--accent);margin-bottom:12px}
.info-links{display:flex;gap:12px;justify-content:center;margin:16px 0}
.info-links a{display:flex;align-items:center;gap:5px;color:var(--text-2);font-size:.78rem;padding:6px 14px;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);transition:.15s;text-decoration:none}
.info-links a:hover{border-color:var(--text-3);color:var(--text-1);background:var(--bg-3)}
.info-links a svg{flex-shrink:0}
.info-site{font-size:.78rem;margin:8px 0}
.info-site a{color:var(--accent)}
.info-site .soon{color:var(--text-3);text-decoration:line-through;font-size:.72rem}
.info-site .soon-label{color:var(--yellow);font-size:.65rem;font-weight:600;margin-left:4px}
.info-loc{font-size:.7rem;color:var(--text-3);margin-top:12px;display:flex;align-items:center;justify-content:center;gap:4px}

/* Main */
#main{flex:1;overflow-y:auto;background:var(--bg-0)}
.container{max-width:1400px;margin:0 auto;padding:20px 24px}

/* Stat cards */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:20px}
.card{background:var(--bg-1);border:1px solid var(--border);border-radius:8px;padding:12px 14px}
.card-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.04em;color:var(--text-3);font-weight:500}
.card-value{font-size:1.2rem;font-weight:700;margin-top:2px}
.card-value.green{color:var(--green)}.card-value.red{color:var(--red)}.card-value.yellow{color:var(--yellow)}.card-value.blue{color:var(--blue)}

/* Tabs */
.tab-bar{display:flex;gap:2px;background:var(--bg-2);border-radius:8px;padding:3px;margin-bottom:16px;width:fit-content}
.tab{padding:5px 14px;border-radius:6px;border:none;background:transparent;color:var(--text-2);font-size:.8rem;font-weight:500;transition:.15s}
.tab:hover{color:var(--text-1)}
.tab.active{background:var(--bg-0);color:var(--text-1);box-shadow:0 1px 3px var(--shadow-card)}

/* Table */
.tbl{width:100%;border-collapse:collapse;font-size:.8rem}
.tbl th{text-align:left;padding:8px 10px;color:var(--text-3);font-weight:500;font-size:.75rem;text-transform:uppercase;letter-spacing:.03em;border-bottom:1px solid var(--border);cursor:pointer;user-select:none;white-space:nowrap}
.tbl th:hover{color:var(--text-1)}
.tbl td{padding:8px 10px;border-bottom:1px solid var(--border-subtle);max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tbl tr:hover td{background:var(--bg-2)}
.tbl tr.selected td{background:var(--accent-bg)}
.tbl tr.focused td{background:var(--bg-2);box-shadow:inset 2px 0 0 var(--accent)}
.row-click{cursor:pointer}
.clickable{cursor:pointer}

/* Tier badges */
.tier{display:inline-flex;align-items:center;gap:4px;font-size:.72rem;font-weight:600;padding:2px 8px;border-radius:10px;white-space:nowrap}
.tier-1{background:var(--red-bg);color:var(--red)}
.tier-2{background:var(--yellow-bg);color:var(--yellow)}
.tier-3{background:rgba(6,182,212,.1);color:var(--blue)}
.tier-4{background:var(--green-bg);color:var(--green)}

/* Tag chips */
.tag{display:inline-flex;align-items:center;gap:3px;font-size:.7rem;padding:2px 8px;border-radius:10px;background:var(--bg-3);color:var(--purple);font-weight:500;margin:1px}
.tag .x{cursor:pointer;opacity:.5;margin-left:2px}.tag .x:hover{opacity:1}

/* Buttons */
.btn{padding:6px 14px;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg-2);color:var(--text-1);font-size:.8rem;font-weight:500;transition:.15s;display:inline-flex;align-items:center;gap:5px}
.btn:hover{background:var(--bg-3);border-color:var(--text-3)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent-h)}
.btn-danger{color:var(--red);border-color:rgba(239,68,68,.3)}
.btn-danger:hover{background:var(--red-bg)}
.btn-sm{padding:3px 10px;font-size:.75rem}
.btn-icon{padding:4px 6px;background:transparent;border:none;color:var(--text-3);font-size:1rem}
.btn-icon:hover{color:var(--text-1)}

/* Star */
.star{cursor:pointer;font-size:1rem;color:var(--text-3);background:none;border:none;padding:0}
.star.active{color:var(--yellow)}

/* Checkbox */
.chk{width:15px;height:15px;accent-color:var(--accent);cursor:pointer}

/* Floating action bar */
#actionBar{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--bg-1);border:1px solid var(--border);border-radius:12px;padding:8px 16px;display:none;align-items:center;gap:12px;box-shadow:0 8px 30px var(--shadow-bar);z-index:100;font-size:.85rem}
#actionBar .count{font-weight:600;color:var(--accent)}

/* Charts */
.charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
.charts-3{grid-template-columns:1fr 1fr 1fr}
.chart-box{background:var(--bg-1);border:1px solid var(--border);border-radius:8px;padding:16px}
.chart-box h4{font-size:.8rem;font-weight:600;color:var(--text-2);margin-bottom:10px}
.chart-box canvas{max-height:220px}

/* Detail view */
#detail{display:none}
.detail-header{display:flex;align-items:flex-start;gap:12px;margin-bottom:16px}
.detail-title{font-size:1.3rem;font-weight:700;flex:1}
.detail-title-input{font-size:1.3rem;font-weight:700;background:var(--bg-2);border:1px solid var(--accent);border-radius:var(--radius);padding:4px 8px;width:100%;color:var(--text-1)}
.detail-meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-bottom:16px}
.detail-row{display:flex;gap:8px;font-size:.8rem;padding:4px 0}
.detail-row .label{color:var(--text-3);min-width:80px;font-weight:500}
.detail-row .value{color:var(--text-1)}
.detail-notes textarea{width:100%;min-height:60px;resize:vertical;font-size:.8rem}
.detail-tags{display:flex;flex-wrap:wrap;align-items:center;gap:4px;margin:8px 0}
.tag-input{width:100px;font-size:.7rem;padding:3px 8px}

/* Conversation viewer */
.msg-list{margin-top:16px}
.msg{padding:12px 16px;border-radius:8px;margin-bottom:8px;font-size:.85rem}
.msg-user{background:rgba(59,130,246,.06);border-left:3px solid var(--accent)}
.msg-assistant{background:rgba(34,197,94,.04);border-left:3px solid var(--green)}
.msg-meta{font-size:.7rem;color:var(--text-3);margin-bottom:6px;display:flex;align-items:center;gap:8px}
.msg-meta .model{background:var(--bg-3);padding:1px 6px;border-radius:3px;font-family:var(--mono);font-size:.65rem}
.msg-content{line-height:1.6;overflow-wrap:break-word}
.msg-content pre{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;overflow-x:auto;margin:8px 0;font-family:var(--mono);font-size:.8rem;line-height:1.4}
.msg-content code{font-family:var(--mono);font-size:.82em;background:var(--bg-3);padding:1px 5px;border-radius:3px}
.msg-content pre code{background:none;padding:0}
.msg-content p{margin:4px 0}
.msg-content ul,.msg-content ol{padding-left:20px;margin:4px 0}
.msg-content ul.contains-task-list{list-style:none;padding-left:4px}
.msg-content li.task-list-item{display:flex;align-items:flex-start;gap:6px}
.msg-content li.task-list-item input[type="checkbox"]{margin-top:5px;accent-color:var(--accent);pointer-events:none}
.msg-content h1,.msg-content h2,.msg-content h3{margin:12px 0 4px;font-size:1em;font-weight:600}
.msg-content table{width:100%;border-collapse:collapse;margin:8px 0;font-size:.8rem}
.msg-content th{text-align:left;padding:6px 10px;border:1px solid var(--border);background:var(--bg-2);font-weight:600;font-size:.75rem}
.msg-content td{padding:6px 10px;border:1px solid var(--border)}
.msg-content tr:hover td{background:var(--bg-2)}
.msg-content blockquote{border-left:3px solid var(--border);padding:4px 12px;margin:8px 0;color:var(--text-2)}
.msg-content hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.msg-content img{max-width:100%;border-radius:var(--radius)}
.thinking-toggle{font-size:.72rem;color:var(--text-3);cursor:pointer;background:var(--bg-3);border:1px solid var(--border);border-radius:4px;padding:3px 10px;margin:4px 0;display:inline-block}
.thinking-toggle:hover{color:var(--text-1)}
.thinking-content{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin:4px 0;font-size:.78rem;color:var(--text-2);white-space:pre-wrap;max-height:400px;overflow-y:auto;display:none;font-family:var(--mono);line-height:1.4}
.tool-block{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:8px 12px;margin:6px 0;font-size:.78rem}
.tool-name{font-weight:600;color:var(--blue);font-family:var(--mono);font-size:.75rem}
.tool-input{color:var(--text-2);margin-top:2px;font-family:var(--mono);font-size:.72rem;word-break:break-all}
.tool-error{color:var(--red)}
.msg-tokens{font-size:.65rem;color:var(--text-3);font-family:var(--mono)}

/* Message search */
.msg-search{display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--bg-1);border:1px solid var(--border);border-radius:8px;margin-bottom:12px}
.msg-search input{flex:1;padding:6px 10px;background:var(--bg-2);color:var(--text-1);border:1px solid var(--border);border-radius:var(--radius);font-size:.82rem;outline:none}
.msg-search input:focus{border-color:var(--accent)}
.msg-search-info{font-size:.72rem;color:var(--text-3);font-family:var(--mono);white-space:nowrap;min-width:50px;text-align:center}
.msg-search button{background:none;border:1px solid var(--border);color:var(--text-2);cursor:pointer;padding:3px 8px;border-radius:var(--radius);font-size:.75rem;transition:.15s}
.msg-search button:hover{color:var(--text-1);border-color:var(--text-3);background:var(--bg-3)}
.search-hl{background:var(--yellow-bg);color:var(--yellow);border-radius:2px;padding:0 1px}
.search-hl-active{background:var(--yellow);color:var(--bg-0);border-radius:2px;padding:0 1px}
.msg-dimmed{opacity:.2;pointer-events:none}
.msg-hidden{display:none}

/* Toast */
#toast{position:fixed;bottom:24px;right:24px;z-index:200}
.toast-item{background:var(--bg-1);border:1px solid var(--border);border-radius:8px;padding:10px 16px;margin-top:8px;font-size:.82rem;box-shadow:0 4px 20px var(--shadow-card);animation:slideUp .2s ease;display:flex;align-items:center;gap:8px}
.toast-item.success{border-left:3px solid var(--green)}.toast-item.error{border-left:3px solid var(--red)}
@keyframes slideUp{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}

/* Pagination */
.pag{display:flex;gap:6px;justify-content:center;align-items:center;margin-top:16px;font-size:.8rem;color:var(--text-2)}

/* Keyboard help */
#kbHelp{position:fixed;inset:0;background:var(--shadow-modal);z-index:300;display:none;align-items:center;justify-content:center}
#kbHelp .modal{background:var(--bg-1);border:1px solid var(--border);border-radius:12px;padding:24px;max-width:400px;width:90%}
#kbHelp h3{margin-bottom:12px;font-size:1rem}
.kb-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:.82rem}
.kb-key{background:var(--bg-3);border:1px solid var(--border);border-radius:4px;padding:1px 8px;font-family:var(--mono);font-size:.75rem}
.kb-edit{cursor:pointer;border-radius:4px;padding:2px 4px;transition:.15s}
.kb-edit:hover{background:var(--bg-3)}
.kb-edit.recording{background:var(--accent-bg);border:1px solid var(--accent);animation:kbPulse 1s infinite}
@keyframes kbPulse{0%,100%{opacity:1}50%{opacity:.6}}

/* Streamer mode */
.streamer-mode .sensitive{filter:blur(5px);user-select:none;transition:filter .2s}
.streamer-mode .sensitive:hover{filter:blur(3px)}

/* Theme toggle */
.theme-btn{background:none;border:none;color:var(--text-3);cursor:pointer;padding:2px;display:flex;align-items:center;transition:color .15s;font-size:.85rem;line-height:1}
.theme-btn:hover{color:var(--accent)}
.theme-label{font-size:.55rem;color:var(--text-3);text-transform:uppercase;letter-spacing:.03em;margin-left:1px}

/* Activity heatmap */
.heatmap-wrap{background:var(--bg-1);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px}
.heatmap-wrap h4{font-size:.8rem;font-weight:600;color:var(--text-2);margin-bottom:10px}
.heatmap-container{overflow-x:auto;scrollbar-width:thin}
.heatmap-container::-webkit-scrollbar{height:4px}
.heatmap-container::-webkit-scrollbar-thumb{background:var(--bg-4);border-radius:2px}
.heatmap{display:flex;gap:2px}
.heatmap-col{display:flex;flex-direction:column;gap:2px}
.heatmap-cell{width:11px;height:11px;border-radius:2px;background:var(--heatmap-0);position:relative;cursor:default}
.heatmap-cell[data-level="1"]{background:var(--heatmap-1)}
.heatmap-cell[data-level="2"]{background:var(--heatmap-2)}
.heatmap-cell[data-level="3"]{background:var(--heatmap-3)}
.heatmap-cell[data-level="4"]{background:var(--heatmap-4)}
.heatmap-labels{display:flex;flex-direction:column;gap:2px;margin-right:4px;flex-shrink:0}
.heatmap-day-label{height:11px;font-size:.6rem;color:var(--text-3);display:flex;align-items:center;line-height:1}
.heatmap-months{display:flex;gap:2px;margin-left:0;padding-left:28px;margin-bottom:4px}
.heatmap-month-label{font-size:.6rem;color:var(--text-3)}
.heatmap-tooltip{position:fixed;background:var(--bg-3);color:var(--text-1);font-size:.72rem;padding:4px 8px;border-radius:4px;pointer-events:none;z-index:500;white-space:nowrap;box-shadow:0 2px 8px var(--shadow-card)}
.heatmap-legend{display:flex;align-items:center;gap:4px;margin-top:8px;font-size:.6rem;color:var(--text-3)}
.heatmap-legend-cell{width:11px;height:11px;border-radius:2px}

/* Cost comparison arrow */
.cost-compare{font-size:.65rem;font-weight:600;display:inline-flex;align-items:center;gap:2px;margin-left:4px}
.cost-compare.up{color:var(--red)}
.cost-compare.down{color:var(--green)}

/* Overview top row: left stack (heatmap + activity) + top sessions */
.overview-top-row{display:flex;gap:12px;margin-bottom:16px;align-items:stretch}
.overview-left-stack{flex:0 0 65%;max-width:65%;display:flex;flex-direction:column;gap:12px}
.overview-left-stack .heatmap-wrap{margin-bottom:0;flex:0 0 auto}
.overview-left-stack .heatmap-wrap h4{margin-bottom:6px}
.overview-left-stack .chart-box{flex:0 0 auto}
.overview-left-stack .chart-box canvas{max-height:150px}
.top-sessions-widget{flex:1;background:var(--bg-1);border:1px solid var(--border);border-radius:8px;padding:16px;display:flex;flex-direction:column;min-height:0}
.top-sessions-widget h4{font-size:.8rem;font-weight:600;color:var(--text-2);margin-bottom:10px}
.ts-tabs{display:flex;gap:2px;background:var(--bg-2);border-radius:6px;padding:2px;margin-bottom:10px}
.ts-tab{padding:4px 10px;border-radius:5px;border:none;background:transparent;color:var(--text-3);font-size:.72rem;font-weight:500;cursor:pointer;transition:.15s}
.ts-tab:hover{color:var(--text-1)}
.ts-tab.active{background:var(--bg-0);color:var(--text-1);box-shadow:0 1px 3px var(--shadow-card)}
.ts-card{padding:8px 10px;border-radius:var(--radius);cursor:pointer;transition:background .1s;border-bottom:1px solid var(--border-subtle)}
.ts-card:last-child{border-bottom:none}
.ts-card:hover{background:var(--bg-2)}
.ts-card-title{font-size:.78rem;font-weight:500;color:var(--text-1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ts-card-meta{font-size:.68rem;color:var(--text-3);display:flex;gap:6px;margin-top:2px}
#tsCards{flex:1;overflow-y:auto;min-height:0}

/* Scrollbar */
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bg-4);border-radius:3px}

/* Responsive */
@media(max-width:768px){
  body{flex-direction:column}
  #sidebar{width:100%;min-width:100%;border-right:none;border-bottom:1px solid var(--border);max-height:48px;overflow:hidden;transition:max-height .3s}
  #sidebar.open{max-height:80vh}
  .sb-header{cursor:pointer}
  .charts{grid-template-columns:1fr}
  .charts-3{grid-template-columns:1fr}
  .overview-top-row{flex-direction:column}
  .overview-left-stack{max-width:100%;flex:auto}
  .top-sessions-widget{max-width:100%}
}
</style>
</head>
<body>
<nav id="sidebar">
  <div class="sb-header" onclick="if(window.innerWidth<=768)this.parentElement.classList.toggle('open')">
    <h1 onclick="event.stopPropagation();showOverview()" style="cursor:pointer" title="Go to dashboard"><span>⬡</span><span class="sb-name"> csesh</span></h1>
    <button class="sb-toggle" id="sbToggle" onclick="event.stopPropagation();toggleSidebar()" title="Collapse sidebar">◀</button>
  </div>
  <div class="sb-search">
    <div class="sb-search-wrap">
      <input type="text" id="globalSearch" placeholder="Search..." onkeydown="if(event.key==='Enter')doGlobalSearch();" onfocus="this.select()">
    </div>
  </div>
  <div class="sb-section">
    <div class="sb-section-title">Projects</div>
    <ul class="sb-list" id="projectList">
      <li class="sb-item active" onclick="selectProject(null)"><span>All Projects</span></li>
    </ul>
  </div>
  <div class="sb-tiers" id="sidebarTiers"></div>
  <div class="sb-footer" id="sidebarFooter"></div>
</nav>

<div id="main">
  <div class="container">
    <div id="loading" style="text-align:center;padding:60px;color:var(--text-3)">
      <div style="font-size:1.5rem;margin-bottom:8px">⬡</div>
      Loading sessions...
    </div>

    <div id="overview" style="display:none">
      <div id="refreshRow" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"></div>
      <div class="cards" id="statCards"></div>
      <div class="overview-top-row">
        <div class="overview-left-stack">
          <div class="heatmap-wrap" id="heatmapWrap">
            <h4>Activity (last 365 days)</h4>
            <div class="heatmap-months" id="heatmapMonths"></div>
            <div class="heatmap-container">
              <div style="display:flex">
                <div class="heatmap-labels" id="heatmapLabels"></div>
                <div class="heatmap" id="heatmapGrid"></div>
              </div>
            </div>
            <div class="heatmap-legend" id="heatmapLegend"></div>
          </div>
          <div class="chart-box"><h4>Activity (last 30 days)</h4><canvas id="activityChart"></canvas></div>
        </div>
        <div class="top-sessions-widget">
          <h4>Top Sessions</h4>
          <div class="ts-tabs">
            <button class="ts-tab active" onclick="setTsTab('recent')">Recent</button>
            <button class="ts-tab" onclick="setTsTab('active')">Most Active</button>
            <button class="ts-tab" onclick="setTsTab('heaviest')">Heaviest</button>
          </div>
          <div id="tsCards"></div>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 4px">
        <span style="font-size:.8rem;color:var(--text-3)">Dashboard</span>
        <button class="btn btn-sm btn-primary" onclick="showList()">Browse Sessions →</button>
      </div>
      <div class="charts charts-3">
        <div class="chart-box"><h4>Model Distribution</h4><canvas id="modelChart"></canvas></div>
        <div class="chart-box"><h4>Token Breakdown</h4><canvas id="tokenChart"></canvas></div>
        <div class="chart-box"><h4>Tier Distribution</h4><canvas id="tierChart"></canvas></div>
      </div>
      <div class="charts">
        <div class="chart-box"><h4>Cost Over Time</h4><canvas id="costChart"></canvas></div>
        <div class="chart-box"><h4>Cost by Project</h4><canvas id="costByProjectChart"></canvas></div>
      </div>
      <div class="charts">
        <div class="chart-box"><h4>Top Tools</h4><canvas id="toolChart"></canvas></div>
        <div class="chart-box"><h4>Top Files</h4><canvas id="filesChart"></canvas></div>
      </div>
    </div>

    <div id="browseNav" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:12px">
        <div class="tab-bar" id="tabs"></div>
        <div id="listControls" style="display:flex;gap:8px;align-items:center">
          <select id="sortSelect" onchange="currentSort=this.value;currentPage=0;renderActive()" style="font-size:.8rem">
            <option value="date">Sort: Date</option>
            <option value="size">Sort: Size</option>
            <option value="messages">Sort: Messages</option>
            <option value="tier">Sort: Tier</option>
            <option value="project">Sort: Project</option>
          </select>
          <input type="text" id="filterInput" placeholder="Filter..." oninput="currentPage=0;renderActive()" style="width:180px;font-size:.8rem">
        </div>
      </div>
    </div>

    <div id="listView" style="display:none">
      <table class="tbl">
        <thead><tr>
          <th style="width:30px"><input type="checkbox" class="chk" onchange="toggleAll(this.checked)"></th>
          <th onclick="sortBy('date')">Date</th>
          <th onclick="sortBy('project')">Project</th>
          <th onclick="sortBy('title')">Title</th>
          <th onclick="sortBy('messages')">Msgs</th>
          <th onclick="sortBy('size')">Size</th>
          <th onclick="sortBy('tier')">Tier</th>
          <th>Actions</th>
        </tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="pag" id="pag"></div>
    </div>

    <div id="detail">
      <div style="margin-bottom:12px">
        <button class="btn btn-sm" onclick="goBack()">← Back</button>
      </div>
      <div id="detailInner"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin:20px 0 8px">
        <h3 style="font-size:.95rem">Conversation</h3>
        <div style="display:flex;gap:6px">
          <button class="btn btn-sm" id="msgOrderBtn" onclick="toggleMsgOrder()" title="Toggle message order">Newest first</button>
          <button class="btn btn-sm" onclick="toggleMsgSearch()" title="Search in conversation (Ctrl+F)">Search</button>
        </div>
      </div>
      <div class="msg-search" id="msgSearchBar" style="display:none">
        <input type="text" id="msgSearchInput" placeholder="Search in conversation..." oninput="debounceMsgSearch()" onkeydown="msgSearchKeydown(event)">
        <span class="msg-search-info" id="msgSearchInfo"></span>
        <button onclick="msgSearchPrev()" title="Previous match (Shift+Enter)">&#9650;</button>
        <button onclick="msgSearchNext()" title="Next match (Enter)">&#9660;</button>
        <button id="msgSearchModeBtn" onclick="toggleMsgSearchMode()" title="Toggle display mode">All</button>
        <button onclick="closeMsgSearch()" title="Close search (Esc)">&times;</button>
      </div>
      <div class="msg-list" id="msgList"></div>
      <div id="msgPag" class="pag"></div>
    </div>

    <div id="trashView" style="display:none">
      <div id="trashActions" style="display:none;margin-bottom:12px;gap:8px;align-items:center">
        <span><span id="trashSelCount">0</span> selected</span>
        <button class="btn btn-sm" onclick="batchRestoreTrash()">Restore Selected</button>
        <button class="btn btn-sm btn-danger" onclick="batchDeleteTrash()">Delete Selected</button>
        <button class="btn btn-sm" onclick="clearTrashSelection()">Cancel</button>
      </div>
      <table class="tbl"><thead><tr>
        <th style="width:30px"><input type="checkbox" class="chk" id="trashSelectAll" onchange="toggleAllTrash(this.checked)"></th>
        <th>Trashed</th><th>Project</th><th>Title</th><th>Score</th><th>Size</th><th>Actions</th>
      </tr></thead><tbody id="trashBody"></tbody></table>
    </div>
  </div>
</div>

<div id="actionBar">
  <span><span class="count" id="selCount">0</span> selected</span>
  <button class="btn btn-sm btn-danger" onclick="batchTrash()">Trash</button>
  <button class="btn btn-sm" onclick="batchTag()">Tag</button>
  <button class="btn btn-sm" onclick="clearSelection()">Cancel</button>
</div>

<div id="toast"></div>

<div id="kbHelp" onclick="this.style.display='none'">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:440px">
    <h3>Keyboard Shortcuts</h3>
    <div style="font-size:.68rem;color:var(--text-3);margin-bottom:8px">Click a key to rebind</div>
    <div id="kbRows"></div>
    <div style="margin-top:12px;display:flex;justify-content:space-between">
      <button class="btn btn-sm" onclick="resetKeybindings()" style="font-size:.7rem;color:var(--text-3)">Reset defaults</button>
      <button class="btn btn-sm" onclick="document.getElementById('kbHelp').style.display='none'">Close</button>
    </div>
  </div>
</div>

<div id="infoModal" onclick="this.style.display='none'">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>csesh</h3>
    <div class="subtitle" id="infoVersion">Claude Code session manager</div>
    <div class="info-author">Arthur Pacaud</div>
    <div class="info-handle">@arthurpcd</div>
    <div class="info-links">
      <a href="https://linkedin.com/in/arthurpacaud" target="_blank" rel="noopener">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>
        LinkedIn
      </a>
      <a href="https://github.com/ArthurPcd" target="_blank" rel="noopener">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
        GitHub
      </a>
    </div>
    <div class="info-site">
      <a href="https://jpstudio.fr" target="_blank" rel="noopener">jpstudio.fr</a>
    </div>
    <div class="info-site">
      <span class="soon">arthurpacaud.dev</span><span class="soon-label">soon</span>
    </div>
    <div style="margin:12px 0;padding:10px;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius)">
      <div style="font-size:.78rem;font-weight:600;margin-bottom:6px">Open Source</div>
      <a href="https://github.com/ArthurPcd/csesh" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:6px;font-size:.78rem;color:var(--accent);margin-bottom:4px">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
        ArthurPcd/csesh
      </a>
      <div style="display:flex;gap:8px;font-size:.72rem">
        <a href="https://github.com/ArthurPcd/csesh" target="_blank" rel="noopener" style="color:var(--text-3)">Star on GitHub</a>
        <a href="https://github.com/sponsors/ArthurPcd" target="_blank" rel="noopener" style="color:var(--text-3)">Sponsor</a>
      </div>
    </div>
    <div class="info-loc">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
      Paris - Lyon, France
    </div>
    <div style="margin-top:16px;text-align:right"><button class="btn btn-sm" onclick="document.getElementById('infoModal').style.display='none'">Close</button></div>
  </div>
</div>

<script>
// ── State ──
let allSessions=[],stats=null,currentProject=null,currentTab='all',currentSort='date',currentPage=0,selectedIds=new Set(),focusIdx=-1,lastDataRefresh=null,currentTsTab='recent';
const PAGE=50;
let charts={};
const tierNames={1:'Auto-delete',2:'Suggested',3:'Review',4:'Keep'};
const tierClasses={1:'tier-1',2:'tier-2',3:'tier-3',4:'tier-4'};

// ── API ──
async function api(p){try{const r=await fetch(p);if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()}catch(e){toast('API error: '+e.message,'error');throw e}}
async function apiPost(p,b){try{const r=await fetch(p,{method:'POST',headers:{'Content-Type':'application/json'},body:b?JSON.stringify(b):undefined});if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()}catch(e){toast('API error: '+e.message,'error');throw e}}
async function apiPatch(p,b){try{const r=await fetch(p,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()}catch(e){toast('API error: '+e.message,'error');throw e}}
async function apiDel(p){try{const r=await fetch(p,{method:'DELETE'});if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()}catch(e){toast('API error: '+e.message,'error');throw e}}

// ── Helpers ──
function fmtBytes(b){if(!b)return'0 B';const u=['B','KB','MB','GB'];const i=Math.min(Math.floor(Math.log(b)/Math.log(1024)),u.length-1);return(b/Math.pow(1024,i)).toFixed(i===0?0:1)+' '+u[i]}
function fmtDur(ms){if(!ms||ms<0)return'0s';if(ms<60000)return Math.round(ms/1000)+'s';if(ms<3600000)return Math.round(ms/60000)+'m';const h=Math.floor(ms/3600000),m=Math.round((ms%3600000)/60000);return m>0?h+'h '+m+'m':h+'h'}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function tierBadge(t){return`<span class="tier ${tierClasses[t]||''}">${tierNames[t]||'?'}</span>`}
function toast(msg,type='success'){const t=document.getElementById('toast');const d=document.createElement('div');d.className='toast-item '+type;d.textContent=msg;t.appendChild(d);setTimeout(()=>d.remove(),3000)}

// ── Init ──
async function init(){
  try{
    const[sessData,projData,statsData]=await Promise.all([api('/api/sessions?limit=5000'),api('/api/projects'),api('/api/stats')]);
    allSessions=sessData.sessions||[];
    stats=statsData;
    lastDataRefresh=new Date();
    renderProjects(projData);
    renderOverview();
    renderTabs();
    document.getElementById('loading').style.display='none';
    document.getElementById('overview').style.display='';
    updateSidebar();
    if(stats.version){document.getElementById('infoVersion').textContent='v'+stats.version+' — Claude Code session manager'}
  }catch(e){document.getElementById('loading').textContent='Error: '+e.message}
}

// ── Sidebar ──
function renderProjects(projects){
  const list=document.getElementById('projectList');
  list.innerHTML='<li class="sb-item active" onclick="selectProject(null)" data-slug=""><span>All Projects</span><span class="sb-badge">'+allSessions.length+'</span></li>'+
    projects.map(p=>'<li class="sb-item" onclick="selectProject(\''+p.slug+'\')" data-slug="'+p.slug+'"><span class="sensitive">'+esc(p.shortName)+'</span><span class="sb-badge">'+p.sessions+'</span></li>').join('');
}
function selectProject(slug){
  currentProject=slug;currentPage=0;currentTab='all';
  document.querySelectorAll('#projectList .sb-item').forEach(li=>li.classList.toggle('active',li.dataset.slug===(slug||'')));
  showList();
}
function updateSidebar(){
  if(!stats)return;
  const td=stats.tierDistribution||{};
  document.getElementById('sidebarTiers').innerHTML=
    '<div class="sb-section-title">Classification</div>'+
    [4,3,2,1].map(t=>'<div class="tier-row"><span><span class="dot" style="background:var(--'+(t===4?'green':t===3?'blue':t===2?'yellow':'red')+')"></span>'+tierNames[t]+'</span><span>'+(td[t]||0)+'</span></div>').join('');
  const isStreamer=document.body.classList.contains('streamer-mode');
  document.getElementById('sidebarFooter').innerHTML=`
    <div class="sb-footer-row">
      <span>${allSessions.length} sessions &middot; ${fmtBytes(stats.totalSize)}</span>
      <span style="font-size:.6rem">v${stats.version||'?'}</span>
    </div>
    <div class="sb-footer-actions">
      <button id="themeToggleBtn" onclick="cycleTheme()" title="Toggle theme">&#9681;</button>
      <button onclick="toggleStreamer()" title="Streamer mode">${isStreamer?'&#128065;&#8205;&#128488;':'&#128065;'}</button>
      <a href="https://github.com/ArthurPcd/csesh" target="_blank" rel="noopener" title="GitHub"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg></a>
      <span onclick="document.getElementById('kbHelp').style.display='flex'" title="Keyboard shortcuts (⌘K)">?</span>
      <button onclick="document.getElementById('infoModal').style.display='flex'" title="About csesh"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></button>
    </div>`;
  updateThemeButton();
}

// ── Overview ──
function renderOverview(){
  if(!stats)return;
  // Refresh row
  const rr=document.getElementById('refreshRow');
  if(rr){
    const ts=lastDataRefresh?lastDataRefresh.toLocaleTimeString():'—';
    rr.innerHTML=`<span style="font-size:.75rem;color:var(--text-3)">Last updated: ${ts}</span><button class="btn btn-sm" onclick="refreshData()" style="font-size:.75rem">&#8635; Refresh</button>`;
  }
  const td=stats.tierDistribution||{};
  const savedSize=stats.trashedSize||0;
  const canSave=stats.junkSize||0;
  const costCompare=getWeeklyCostComparison();
  const costArrow=costCompare!==null?`<span class="cost-compare ${costCompare>=0?'up':'down'}">${costCompare>=0?'&#9650;':'&#9660;'} ${Math.abs(costCompare).toFixed(0)}%</span>`:'';
  document.getElementById('statCards').innerHTML=`
    <div class="card" style="cursor:pointer" onclick="showList()"><div class="card-label">Sessions</div><div class="card-value">${stats.totalSessions}</div></div>
    <div class="card"><div class="card-label">Disk Usage</div><div class="card-value">${stats.totalSizeFormatted}</div></div>
    <div class="card"><div class="card-label">Keep</div><div class="card-value green">${td[4]||0}</div></div>
    <div class="card"><div class="card-label">Auto-delete</div><div class="card-value red">${td[1]||0}</div></div>
    <div class="card"><div class="card-label">Messages</div><div class="card-value">${(stats.totalUserMessages+stats.totalAssistantMessages).toLocaleString()}</div></div>
    <div class="card"><div class="card-label">Est. Cost ${costArrow}</div><div class="card-value">$${stats.totalCost.toFixed(2)}</div></div>
    <div class="card" style="border-color:var(--green);border-left:3px solid var(--green)"><div class="card-label">Disk Freed by csesh</div><div class="card-value green">${savedSize>0?fmtBytes(savedSize):'—'}</div><div style="font-size:.65rem;color:var(--text-3)">${stats.trashedCount||0} sessions cleaned</div></div>
    <div class="card" style="border-left:3px solid var(--yellow)"><div class="card-label">Reclaimable</div><div class="card-value yellow">${fmtBytes(canSave)}</div><div style="font-size:.65rem;color:var(--text-3)">${(td[1]||0)+(td[2]||0)} deletable &middot; ${((canSave/(stats.totalSize||1))*100).toFixed(0)}% of total</div></div>
    <div class="card"><div class="card-label">Avg Cost/Session</div><div class="card-value">$${(stats.avgCostPerSession||0).toFixed(3)}</div></div>
    <div class="card"><div class="card-label">Avg Messages</div><div class="card-value">${stats.avgMessagesPerSession||0}</div></div>`;
  renderCharts();
  renderTopSessions();
}
async function refreshData(){
  try{
    const[sessData,projData,statsData]=await Promise.all([api('/api/sessions?limit=5000'),api('/api/projects'),api('/api/stats')]);
    allSessions=sessData.sessions||[];
    stats=statsData;
    lastDataRefresh=new Date();
    renderProjects(projData);
    renderOverview();
    updateSidebar();
    toast('Data refreshed');
  }catch(e){toast('Refresh failed: '+e.message,'error')}
}
function getChartColors(){
  const s=getComputedStyle(document.documentElement);
  return{text:s.getPropertyValue('--text-3').trim(),border:s.getPropertyValue('--border').trim(),grid:s.getPropertyValue('--chart-grid').trim()};
}
function renderCharts(){
  const cc=getChartColors();
  Chart.defaults.color=cc.text;Chart.defaults.borderColor=cc.border;
  // Activity
  if(charts.activity)charts.activity.destroy();
  const days=Object.entries(stats.activityByDay||{}).sort((a,b)=>a[0].localeCompare(b[0])).slice(-30);
  charts.activity=new Chart(document.getElementById('activityChart'),{type:'bar',data:{labels:days.map(d=>d[0].slice(5)),datasets:[{label:'Sessions',data:days.map(d=>d[1].sessions),backgroundColor:'rgba(59,130,246,.5)',borderRadius:3},{label:'Messages',data:days.map(d=>d[1].messages),backgroundColor:'rgba(34,197,94,.3)',borderRadius:3}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{boxWidth:12,padding:10,font:{size:11}}}},scales:{x:{grid:{display:false}},y:{beginAtZero:true,grid:{color:cc.grid}}}}});
  // Models
  if(charts.model)charts.model.destroy();
  const models=Object.entries(stats.modelCounts||{}).sort((a,b)=>b[1]-a[1]);
  const mColors=['#3b82f6','#22c55e','#f59e0b','#ef4444','#a855f7','#ec4899','#06b6d4'];
  charts.model=new Chart(document.getElementById('modelChart'),{type:'doughnut',data:{labels:models.map(m=>m[0].replace('claude-','')),datasets:[{data:models.map(m=>m[1]),backgroundColor:mColors,borderWidth:0}]},options:{responsive:true,cutout:'60%',plugins:{legend:{position:'bottom',labels:{boxWidth:10,padding:8,font:{size:11}}}}}});
  // Tier
  if(charts.tier)charts.tier.destroy();
  const td=stats.tierDistribution||{};
  charts.tier=new Chart(document.getElementById('tierChart'),{type:'bar',data:{labels:['Keep','Review','Suggested','Auto-delete'],datasets:[{data:[td[4]||0,td[3]||0,td[2]||0,td[1]||0],backgroundColor:['rgba(34,197,94,.5)','rgba(6,182,212,.5)','rgba(245,158,11,.5)','rgba(239,68,68,.5)'],borderRadius:4}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{grid:{color:cc.grid}},y:{grid:{display:false}}}}});
  // Tools
  if(charts.tool)charts.tool.destroy();
  const tools=Object.entries(stats.toolUsageTotal||{}).sort((a,b)=>b[1]-a[1]).slice(0,8);
  charts.tool=new Chart(document.getElementById('toolChart'),{type:'bar',data:{labels:tools.map(t=>t[0]),datasets:[{data:tools.map(t=>t[1]),backgroundColor:'rgba(168,85,247,.4)',borderRadius:4}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{grid:{color:cc.grid}},y:{grid:{display:false}}}}});
  // Cost over time
  if(charts.cost)charts.cost.destroy();
  const costDays=Object.entries(stats.costByDay||{}).sort((a,b)=>a[0].localeCompare(b[0])).slice(-30);
  charts.cost=new Chart(document.getElementById('costChart'),{type:'line',data:{labels:costDays.map(d=>d[0].slice(5)),datasets:[{label:'Cost ($)',data:costDays.map(d=>+d[1].toFixed(4)),borderColor:'rgba(245,158,11,.8)',backgroundColor:'rgba(245,158,11,.1)',borderWidth:2,fill:true,tension:.3,pointRadius:2}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true,grid:{color:cc.grid}}}}});
  // Cost by project (use stats if available, else compute client-side)
  if(charts.costByProject)charts.costByProject.destroy();
  let cbp=stats.costByProject;
  if(!cbp||!Object.keys(cbp).length){
    const PRICING={default:{i:3,o:15,cr:.3,cw:3.75}};
    cbp={};
    allSessions.forEach(s=>{const p=s.shortProject||'unknown';const t=s.tokenUsage||{};const M=1e6;const c=((t.input||0)/M)*3+((t.output||0)/M)*15+((t.cacheRead||0)/M)*.3+((t.cacheWrite||0)/M)*3.75;cbp[p]=(cbp[p]||0)+c});
  }
  const projEntries=Object.entries(cbp).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const projLabels=projEntries.map(e=>{const n=e[0];return n.length>20?n.slice(0,18)+'…':n});
  const projColors=['rgba(59,130,246,.5)','rgba(34,197,94,.5)','rgba(245,158,11,.5)','rgba(239,68,68,.5)','rgba(168,85,247,.5)','rgba(236,72,153,.5)','rgba(6,182,212,.5)','rgba(132,204,22,.5)','rgba(251,146,60,.5)','rgba(167,139,250,.5)'];
  charts.costByProject=new Chart(document.getElementById('costByProjectChart'),{type:'bar',data:{labels:projLabels,datasets:[{data:projEntries.map(e=>+e[1].toFixed(2)),backgroundColor:projColors.slice(0,projEntries.length),borderRadius:4}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:(ctx)=>'$'+ctx.parsed.x.toFixed(2),title:(items)=>projEntries[items[0].dataIndex]?.[0]||''}}},scales:{x:{grid:{color:cc.grid},ticks:{callback:v=>'$'+v}},y:{grid:{display:false},ticks:{font:{size:10}}}}}});
  // Top files
  if(charts.files)charts.files.destroy();
  const topFiles=(stats.topFiles||[]).slice(0,8);
  const fileLabels=topFiles.map(f=>{const p=f.file;return p.length>30?'…'+p.slice(-28):p});
  charts.files=new Chart(document.getElementById('filesChart'),{type:'bar',data:{labels:fileLabels,datasets:[{data:topFiles.map(f=>f.count),backgroundColor:'rgba(6,182,212,.4)',borderRadius:4}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{title:(items)=>topFiles[items[0].dataIndex]?.file||''}}},scales:{x:{grid:{color:cc.grid}},y:{grid:{display:false},ticks:{font:{size:10}}}}}});
  // Token breakdown
  if(charts.token)charts.token.destroy();
  const tk=stats.tokens||{};
  const tkData=[tk.input||0,tk.output||0,tk.cacheRead||0,tk.cacheWrite||0].map(v=>Math.round(v));
  const tkLabels=['Input','Output','Cache Read','Cache Write'];
  const tkColors=['#3b82f6','#22c55e','#f59e0b','#a855f7'];
  charts.token=new Chart(document.getElementById('tokenChart'),{type:'doughnut',data:{labels:tkLabels,datasets:[{data:tkData,backgroundColor:tkColors,borderWidth:0}]},options:{responsive:true,cutout:'60%',plugins:{legend:{position:'bottom',labels:{boxWidth:10,padding:8,font:{size:11}}},tooltip:{callbacks:{label:(ctx)=>{const v=ctx.parsed;const t=tkData.reduce((a,b)=>a+b,0);const pct=t>0?((v/t)*100).toFixed(1)+'%':'0%';return ctx.label+': '+(v>1e6?(v/1e6).toFixed(1)+'M':(v/1e3).toFixed(0)+'K')+' ('+pct+')'}}}}}});
  // Heatmap
  renderHeatmap();
}

// ── Tabs ──
function renderTabs(){
  const tabs=[{id:'all',label:'All'},{id:'keep',label:'Keep'},{id:'review',label:'Review'},{id:'suggested',label:'Suggested'},{id:'auto-delete',label:'Auto-delete'},{id:'trash',label:'Trash'},{id:'favorites',label:'★'}];
  document.getElementById('tabs').innerHTML=
    `<button class="tab" onclick="showOverview()" title="Back to Dashboard" style="color:var(--accent);font-size:.8rem">⬡</button>`+
    tabs.map(t=>`<button class="tab${currentTab===t.id?' active':''}" onclick="setTab('${t.id}')">${t.label}</button>`).join('');
}
function setTab(id){currentTab=id;currentPage=0;focusIdx=-1;renderTabs();if(id==='trash'){showTrash()}else{showListFromTab()}}
function renderActive(){if(currentTab==='trash')renderTrashTable();else renderTable()}

// ── List View ──
function showList(){
  ['overview','detail','trashView'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('browseNav').style.display='';
  document.getElementById('listControls').style.display='flex';
  document.getElementById('listView').style.display='';
  currentPage=0;focusIdx=-1;renderTabs();renderTable();
}
function showListFromTab(){
  // Called from tab click — keep browseNav visible, just swap content
  document.getElementById('trashView').style.display='none';
  document.getElementById('listControls').style.display='flex';
  document.getElementById('listView').style.display='';
  currentPage=0;focusIdx=-1;renderTable();
}
function showOverview(){
  ['browseNav','listView','detail','trashView'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('overview').style.display='';
}
function getFiltered(){
  let s=[...allSessions];
  if(currentProject)s=s.filter(x=>x.slug===currentProject);
  if(currentTab==='keep')s=s.filter(x=>x.tier===4);
  else if(currentTab==='review')s=s.filter(x=>x.tier===3);
  else if(currentTab==='suggested')s=s.filter(x=>x.tier===2);
  else if(currentTab==='auto-delete')s=s.filter(x=>x.tier===1);
  else if(currentTab==='favorites')s=s.filter(x=>x.favorite);
  const q=document.getElementById('filterInput')?.value?.toLowerCase();
  if(q)s=s.filter(x=>(x.title||'').toLowerCase().includes(q)||(x.displayTitle||'').toLowerCase().includes(q)||(x.shortProject||'').toLowerCase().includes(q)||(x.gitBranch||'').toLowerCase().includes(q)||(x.id||'').toLowerCase().includes(q)||(x.tags||[]).some(t=>t.includes(q))||(x.autoTags||[]).some(t=>t.includes(q)));
  switch(currentSort){
    case'size':s.sort((a,b)=>b.fileSizeBytes-a.fileSizeBytes);break;
    case'messages':s.sort((a,b)=>(b.userMessageCount+b.assistantMessageCount)-(a.userMessageCount+a.assistantMessageCount));break;
    case'tier':s.sort((a,b)=>a.tier-b.tier);break;
    case'project':s.sort((a,b)=>(a.shortProject||'').localeCompare(b.shortProject||''));break;
    case'title':s.sort((a,b)=>(a.displayTitle||a.title||'').localeCompare(b.displayTitle||b.title||''));break;
    default:s.sort((a,b)=>{if(!a.lastTimestamp)return 1;if(!b.lastTimestamp)return-1;return new Date(b.lastTimestamp)-new Date(a.lastTimestamp)})
  }
  return s;
}
function renderTable(){
  const f=getFiltered(),start=currentPage*PAGE,page=f.slice(start,start+PAGE);
  const body=document.getElementById('tableBody');
  body.innerHTML=page.map((s,i)=>{
    const sel=selectedIds.has(s.id);
    const fav=s.favorite?'<span style="color:var(--yellow)">★</span> ':'';
    const title=fav+esc((s.displayTitle||s.title||'').slice(0,55));
    const tags=(s.tags||[]).slice(0,2).map(t=>'<span class="tag">#'+esc(t)+'</span>').join('');
    const date=s.lastTimestamp?new Date(s.lastTimestamp).toLocaleDateString('en-CA'):'—';
    const idx=start+i;
    return`<tr class="row-click${sel?' selected':''}" data-idx="${idx}" data-id="${s.id}" onclick="rowClick('${s.id}',event)">
      <td><input type="checkbox" class="chk" ${sel?'checked':''} onchange="toggleSelect('${s.id}',this.checked)" onclick="event.stopPropagation()"></td>
      <td>${date}</td>
      <td class="sensitive">${esc((s.shortProject||'').slice(0,18))}</td>
      <td>${title} ${tags}</td>
      <td>${s.userMessageCount+s.assistantMessageCount}</td>
      <td>${fmtBytes(s.fileSizeBytes)}</td>
      <td>${tierBadge(s.tier)}</td>
      <td><button class="btn-icon" title="Trash" onclick="event.stopPropagation();trashOne('${s.id}')">🗑</button></td>
    </tr>`}).join('');
  // Pagination
  const totalPages=Math.ceil(f.length/PAGE),pag=document.getElementById('pag');
  if(totalPages>1){let h='';if(currentPage>0)h+=`<button class="btn btn-sm" onclick="currentPage--;renderTable()">← Prev</button>`;h+=`<span>${currentPage+1} / ${totalPages} (${f.length})</span>`;if(currentPage<totalPages-1)h+=`<button class="btn btn-sm" onclick="currentPage++;renderTable()">Next →</button>`;pag.innerHTML=h}else{pag.innerHTML=`<span>${f.length} sessions</span>`}
  updateActionBar();
}
function sortBy(field){currentSort=field;currentPage=0;document.getElementById('sortSelect').value=field;renderTable()}

// ── Selection ──
function toggleSelect(id,checked){if(checked)selectedIds.add(id);else selectedIds.delete(id);renderTable()}
function toggleAll(checked){const f=getFiltered().slice(currentPage*PAGE,(currentPage+1)*PAGE);f.forEach(s=>{if(checked)selectedIds.add(s.id);else selectedIds.delete(s.id)});renderTable()}
function clearSelection(){selectedIds.clear();renderTable()}
function updateActionBar(){const bar=document.getElementById('actionBar');if(selectedIds.size>0){bar.style.display='flex';document.getElementById('selCount').textContent=selectedIds.size}else{bar.style.display='none'}}
async function batchTrash(){if(!confirm(`Trash ${selectedIds.size} sessions?`))return;await apiPost('/api/batch/trash',{ids:[...selectedIds]});allSessions=allSessions.filter(s=>!selectedIds.has(s.id));selectedIds.clear();renderTable();toast(`Trashed sessions`)}
function batchTag(){
  const bar=document.getElementById('actionBar');
  if(bar.querySelector('.batch-tag-input'))return;
  const inp=document.createElement('input');
  inp.type='text';inp.placeholder='Tag name...';inp.className='batch-tag-input';inp.style.cssText='width:120px;font-size:.8rem;padding:4px 8px;border-radius:var(--radius);border:1px solid var(--accent);background:var(--bg-2);color:var(--text-1)';
  bar.insertBefore(inp,bar.querySelector('.btn-sm:nth-child(3)'));
  inp.focus();
  const doTag=async()=>{const tag=inp.value.trim();inp.remove();if(!tag)return;await apiPost('/api/batch/tag',{ids:[...selectedIds],tag});selectedIds.clear();const d=await api('/api/sessions?limit=5000');allSessions=d.sessions||[];renderTable();toast(`Tagged with #${tag}`)};
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')doTag();if(e.key==='Escape')inp.remove()});
  inp.addEventListener('blur',()=>setTimeout(()=>inp.parentNode&&inp.remove(),200));
}

// ── Detail ──
let currentDetailId=null,msgOffset=0,previousView='listView';
let allDetailMessages=[],allMessagesLoaded=false,searchMatches=[],currentMatchIdx=-1,msgSearchMode='all',msgSearchTimer=null,msgOrderReversed=false;
async function showDetail(id){
  currentDetailId=id;msgOffset=0;
  allDetailMessages=[];allMessagesLoaded=false;searchMatches=[];currentMatchIdx=-1;msgSearchMode='all';msgOrderReversed=false;
  const sb=document.getElementById('msgSearchBar');if(sb)sb.style.display='none';
  const mi=document.getElementById('msgSearchInput');if(mi)mi.value='';
  const mb=document.getElementById('msgSearchModeBtn');if(mb)mb.textContent='All';
  const ob=document.getElementById('msgOrderBtn');if(ob)ob.textContent='Newest first';
  // Track which view we came from
  if(document.getElementById('trashView').style.display!=='none')previousView='trashView';
  else if(document.getElementById('overview').style.display!=='none')previousView='overview';
  else previousView='listView';
  ['overview','browseNav','listView','trashView'].forEach(x=>document.getElementById(x).style.display='none');
  document.getElementById('detail').style.display='block';
  document.getElementById('detailInner').innerHTML='<div style="text-align:center;padding:40px;color:var(--text-3)">Loading session...</div>';
  document.getElementById('msgList').innerHTML='';
  let s;
  try{s=await api(`/api/sessions/${id}`)}catch(e){toast('Failed to load session','error');goBack();return;}
  if(!s||s.error){toast(s?.error||'Session not found','error');goBack();return;}
  const tags=(s.tags||[]).map(t=>`<span class="tag">#${esc(t)} <span class="x" data-sid="${s.id}" data-tag="${esc(t)}" onclick="removeTagFromSession(this.dataset.sid,this.dataset.tag)">×</span></span>`).join('');
  const autoTags=(s.autoTags||[]).map(t=>`<span class="tag" style="opacity:.6">#${esc(t)}</span>`).join('');
  document.getElementById('detailInner').innerHTML=`
    <div class="detail-header">
      <div class="detail-title" id="titleDisplay" ondblclick="editTitle('${s.id}')">${esc(s.displayTitle||s.title)} <button class="btn-icon" onclick="editTitle('${s.id}')" title="Edit title">✎</button></div>
      <button class="star ${s.favorite?'active':''}" onclick="toggleFav('${s.id}',this)" title="Favorite">${s.favorite?'★':'☆'}</button>
      ${tierBadge(s.tier)}
    </div>
    <div class="detail-tags">${tags}${autoTags}<input type="text" class="tag-input" placeholder="+tag" onkeydown="if(event.key==='Enter'){addTagToSession('${s.id}',this.value);this.value=''}"></div>
    <div class="cards" style="grid-template-columns:repeat(auto-fit,minmax(130px,1fr))">
      <div class="card"><div class="card-label">Project</div><div class="card-value" style="font-size:.9rem">${esc(s.shortProject)}</div></div>
      <div class="card"><div class="card-label">Date</div><div class="card-value" style="font-size:.9rem">${s.firstTimestamp?new Date(s.firstTimestamp).toLocaleDateString():''}</div></div>
      <div class="card"><div class="card-label">Duration</div><div class="card-value">${fmtDur(s.durationMs)}</div></div>
      <div class="card"><div class="card-label">Messages</div><div class="card-value">${s.userMessageCount+s.assistantMessageCount}</div></div>
      <div class="card"><div class="card-label">Tools</div><div class="card-value">${s.totalToolCalls||0}</div></div>
      <div class="card"><div class="card-label">Thinking</div><div class="card-value">${s.thinkingBlocks||0}</div></div>
      <div class="card"><div class="card-label">Files</div><div class="card-value">${s.uniqueFilesCount||0}</div></div>
      <div class="card"><div class="card-label">Size</div><div class="card-value">${fmtBytes(s.fileSizeBytes)}</div></div>
    </div>
    <details style="margin:12px 0"><summary style="font-size:.8rem;color:var(--text-2);cursor:pointer">More details</summary>
    <div style="padding:8px 0">
      <div class="detail-row"><span class="label">ID</span><span class="value sensitive" style="font-family:var(--mono);font-size:.75rem">${s.id}</span></div>
      <div class="detail-row"><span class="label">Category</span><span class="value">${s.category}</span></div>
      <div class="detail-row"><span class="label">Branch</span><span class="value sensitive">${esc(s.gitBranch||'—')}</span></div>
      <div class="detail-row"><span class="label">CWD</span><span class="value sensitive">${esc(s.cwd||'—')}</span></div>
      <div class="detail-row"><span class="label">Version</span><span class="value">${s.version||'—'}</span></div>
      <div class="detail-row"><span class="label">Models</span><span class="value">${(s.models||[]).join(', ')}</span></div>
      <div class="detail-row"><span class="label">Tokens</span><span class="value">${(s.tokenUsage?.input||0).toLocaleString()} in, ${(s.tokenUsage?.output||0).toLocaleString()} out, ${(s.tokenUsage?.cacheRead||0).toLocaleString()} cached</span></div>
      <div class="detail-row"><span class="label">Language</span><span class="value">${s.language||'—'}</span></div>
      ${s.junkReasons?.length?'<div class="detail-row"><span class="label">Reasons</span><span class="value">'+esc(s.junkReasons.join(', '))+'</span></div>':''}
    </div></details>
    <div class="detail-notes" style="margin:8px 0">
      <textarea placeholder="Add notes..." onblur="saveNotes('${s.id}',this.value)">${esc(s.notes||'')}</textarea>
    </div>
    <div class="launch-section" style="margin:16px 0;padding:16px;background:var(--bg-2);border-radius:8px;border:1px solid var(--border)">
      <div style="font-weight:600;margin-bottom:10px;font-size:.9rem">Resume in Terminal</div>
      <div class="launch-row" style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <code class="launch-cmd" style="flex:1;padding:8px 12px;background:var(--bg-1);border-radius:6px;font-size:.8rem;font-family:var(--mono);overflow-x:auto;white-space:nowrap">cd ${esc(s.cwd||s.project||'~')} && claude --resume ${s.id}</code>
        <button class="btn btn-sm" onclick="copyCmd('cd ${(s.cwd||s.project||'~').replace(/'/g,"\\'")} && claude --resume ${s.id}',this)" title="Copy">Copy</button>
        <button class="btn btn-sm btn-icon" onclick="openTerm('cd ${(s.cwd||s.project||'~').replace(/'/g,"\\'")} && claude --resume ${s.id}')" title="Open in terminal"><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="2 4 6 8 2 12"/><line x1="8" y1="12" x2="14" y2="12"/></svg></button>
      </div>
      <div class="launch-row" style="display:flex;align-items:center;gap:8px">
        <code class="launch-cmd" style="flex:1;padding:8px 12px;background:var(--bg-1);border-radius:6px;font-size:.8rem;font-family:var(--mono);overflow-x:auto;white-space:nowrap;opacity:.7">cd ${esc(s.cwd||s.project||'~')} && claude --resume ${s.id} --dangerously-skip-permissions</code>
        <button class="btn btn-sm" onclick="copyCmd('cd ${(s.cwd||s.project||'~').replace(/'/g,"\\'")} && claude --resume ${s.id} --dangerously-skip-permissions',this)" title="Copy" style="opacity:.7">Copy</button>
        <button class="btn btn-sm btn-icon" onclick="openTerm('cd ${(s.cwd||s.project||'~').replace(/'/g,"\\'")} && claude --resume ${s.id} --dangerously-skip-permissions')" title="Open in terminal" style="opacity:.7"><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="2 4 6 8 2 12"/><line x1="8" y1="12" x2="14" y2="12"/></svg></button>
      </div>
      <div style="font-size:.7rem;color:var(--text-3);margin-top:6px">Copy or click <svg width="10" height="10" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle"><polyline points="2 4 6 8 2 12"/><line x1="8" y1="12" x2="14" y2="12"/></svg> to open in your default terminal. The renamed title appears in the <code style="font-size:.65rem">claude --resume</code> picker.</div>
    </div>`;
  loadMessages(id);
}
function renderSingleMessage(m){
  let content='';
  if(m.blocks?.length){
    for(const b of m.blocks){
      if(b.type==='text'){content+=renderMarkdown(b.text)}
      else if(b.type==='thinking'){const id='th_'+Math.random().toString(36).slice(2);content+=`<div class="thinking-toggle" onclick="const c=document.getElementById('${id}');c.style.display=c.style.display==='block'?'none':'block'">💭 Thinking (${b.chars.toLocaleString()} chars)</div><div class="thinking-content" id="${id}">${esc(b.text)}</div>`}
      else if(b.type==='tool_use'){content+=`<div class="tool-block"><span class="tool-name">${esc(b.name)}</span><div class="tool-input">${esc(b.input||'')}</div></div>`}
      else if(b.type==='tool_result'){content+=`<div class="tool-block${b.isError?' tool-error':''}"><span class="tool-name">${b.isError?'Error':'Result'}</span><div class="tool-input">${esc((b.content||'').slice(0,500))}</div></div>`}
    }
  }else{content=renderMarkdown(m.content||'')}
  const tokens=m.usage?`<span class="msg-tokens">${m.usage.input}in ${m.usage.output}out</span>`:'';
  return`<div class="msg msg-${m.type}"><div class="msg-meta"><span>${m.type==='user'?'User':'Assistant'}</span>${m.model?'<span class="model">'+esc(m.model.replace('claude-',''))+'</span>':''}${m.timestamp?'<span>'+esc(new Date(m.timestamp).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+' '+new Date(m.timestamp).toLocaleTimeString())+'</span>':''}${tokens}</div><div class="msg-content">${content}</div></div>`;
}
async function loadMessages(id,offset=0){
  const ml=document.getElementById('msgList');
  if(offset===0)ml.innerHTML='<div style="color:var(--text-3);padding:16px">Loading messages...</div>';
  const data=await api(`/api/sessions/${id}/messages?offset=${offset}&limit=100`);
  if(!data.messages?.length&&offset===0){ml.innerHTML='<div style="color:var(--text-3);padding:16px">No messages</div>';return}
  const html=data.messages.map(m=>renderSingleMessage(m)).join('');
  if(offset===0)ml.innerHTML=html;else ml.insertAdjacentHTML('beforeend',html);
  // Load more
  const mp=document.getElementById('msgPag');
  if(data.total>offset+100){mp.innerHTML=`<button class="btn btn-sm" onclick="loadMessages('${esc(id)}',${offset+100})">Load more (${data.total-offset-100} remaining)</button>`}else{mp.innerHTML=''}
}
function sanitizeHtml(html){
  return typeof DOMPurify!=='undefined'?DOMPurify.sanitize(html):esc(html);
}
function renderMarkdown(text){
  if(!text)return'';
  try{if(typeof marked!=='undefined')return sanitizeHtml(marked.parse(text))}catch{}
  return'<pre>'+esc(text)+'</pre>';
}
function copyCmd(cmd,btn){navigator.clipboard.writeText(cmd).then(()=>{const orig=btn.textContent;btn.textContent='Copied!';setTimeout(()=>btn.textContent=orig,1500)}).catch(()=>toast('Copy failed','error'))}
async function openTerm(cmd){try{await apiPost('/api/open-terminal',{cmd});toast('Opened in terminal')}catch{navigator.clipboard.writeText(cmd);toast('Copied — paste in your terminal')}}
function goBack(){
  document.getElementById('detail').style.display='none';
  if(previousView==='trashView'){document.getElementById('trashView').style.display=''}
  else if(previousView==='overview'){document.getElementById('overview').style.display=''}
  else{document.getElementById('listView').style.display=''}
}

// ── Row click (selection mode vs detail) ──
function rowClick(id,event){
  if(selectedIds.size>0){
    // In selection mode: toggle selection instead of opening detail
    const was=selectedIds.has(id);
    if(was)selectedIds.delete(id);else selectedIds.add(id);
    renderTable();
    return;
  }
  showDetail(id);
}

// ── Actions ──
async function editTitle(id){
  const el=document.getElementById('titleDisplay');
  const current=(el.dataset.title||el.textContent||'').replace(/✎/,'').trim();
  el.innerHTML=`<input class="detail-title-input" id="titleInput" value="${current.replace(/"/g,'&quot;')}">`;
  const inp=document.getElementById('titleInput');
  inp.focus();inp.select();
  let saved=false;
  const save=async()=>{
    if(saved)return;saved=true;
    const v=inp.value.trim();
    if(v&&v!==current){
      const res=await apiPatch(`/api/sessions/${id}/meta`,{customTitle:v});
      const s=allSessions.find(x=>x.id===id);
      if(s){s.customTitle=v;s.displayTitle=v}
      if(res.slugRenamed)toast('Renamed — visible in claude --resume');
      else toast('Title updated (slug unchanged)');
    }
    const display=v||current;
    el.dataset.title=display;
    el.innerHTML=esc(display)+` <button class="btn-icon" onclick="editTitle('${id}')" title="Edit title">✎</button>`;
  };
  inp.addEventListener('blur',save,{once:true});
  inp.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();inp.blur()}if(e.key==='Escape'){saved=true;inp.value=current;inp.blur();el.dataset.title=current;el.innerHTML=esc(current)+` <button class="btn-icon" onclick="editTitle('${id}')" title="Edit title">✎</button>`}});
}
async function toggleFav(id,btn){
  const res=await apiPost(`/api/sessions/${id}/favorite`);
  const s=allSessions.find(x=>x.id===id);
  if(s)s.favorite=res.favorite;
  btn.textContent=res.favorite?'★':'☆';
  btn.classList.toggle('active',res.favorite);
  toast(res.favorite?'Added to favorites':'Removed from favorites');
}
async function addTagToSession(id,tag){
  if(!tag)return;
  await apiPost(`/api/sessions/${id}/tags`,{tag});
  const s=allSessions.find(x=>x.id===id);
  if(s&&!s.tags)s.tags=[];
  if(s)s.tags.push(tag.toLowerCase());
  showDetail(id);toast(`Tagged #${tag}`);
}
async function removeTagFromSession(id,tag){
  await apiDel(`/api/sessions/${id}/tags/${encodeURIComponent(tag)}`);
  const s=allSessions.find(x=>x.id===id);
  if(s)s.tags=(s.tags||[]).filter(t=>t!==tag);
  showDetail(id);toast(`Removed #${tag}`);
}
async function saveNotes(id,text){
  await apiPatch(`/api/sessions/${id}/meta`,{notes:text});
  const s=allSessions.find(x=>x.id===id);
  if(s)s.notes=text;
}
async function trashOne(id){
  if(!confirm('Trash this session?'))return;
  await apiPost(`/api/trash/${id}`);
  allSessions=allSessions.filter(s=>s.id!==id);
  selectedIds.delete(id);
  renderTable();toast('Session trashed');
}

// ── Trash View ──
let trashSelectedIds=new Set(),trashItems=[];
async function showTrash(){
  ['overview','listView','detail'].forEach(x=>document.getElementById(x).style.display='none');
  document.getElementById('browseNav').style.display='';
  document.getElementById('listControls').style.display='flex';
  document.getElementById('trashView').style.display='';
  trashSelectedIds.clear();
  updateTrashActionBar();
  trashItems=await api('/api/trash');
  renderTrashTable();
}
function getFilteredTrash(){
  let items=[...trashItems];
  const q=document.getElementById('filterInput')?.value?.toLowerCase();
  if(q)items=items.filter(i=>(i.title||'').toLowerCase().includes(q)||(i.project||'').toLowerCase().includes(q)||(i.id||'').toLowerCase().includes(q));
  switch(currentSort){
    case'size':items.sort((a,b)=>(b.fileSizeBytes||0)-(a.fileSizeBytes||0));break;
    case'project':items.sort((a,b)=>(a.project||'').localeCompare(b.project||''));break;
    case'title':items.sort((a,b)=>(a.title||'').localeCompare(b.title||''));break;
    default:items.sort((a,b)=>{const da=a.trashedAt||'';const db=b.trashedAt||'';return db.localeCompare(da)})
  }
  return items;
}
function renderTrashTable(){
  const body=document.getElementById('trashBody');
  const filtered=getFilteredTrash();
  if(!filtered.length){body.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--text-3);padding:24px">'+(trashItems.length?'No matches':'Trash is empty')+'</td></tr>';return}
  body.innerHTML=filtered.map(i=>`<tr>
    <td><input type="checkbox" class="chk" ${trashSelectedIds.has(i.id)?'checked':''} onchange="toggleTrashSelect('${i.id}',this.checked)"></td>
    <td>${i.trashedAt?.slice(0,10)||'—'}</td><td>${esc(i.project||'')}</td>
    <td>${esc((i.title||'').slice(0,45))}</td><td>${tierBadge(i.junkScore>=.6?1:i.junkScore>=.3?2:3)}</td>
    <td>${fmtBytes(i.fileSizeBytes||0)}</td>
    <td><button class="btn btn-sm" onclick="restoreOne('${i.id}')">Restore</button> <button class="btn btn-sm btn-danger" onclick="deleteOne('${i.id}')">Delete</button></td>
  </tr>`).join('');
  document.getElementById('trashSelectAll').checked=trashSelectedIds.size===filtered.length&&filtered.length>0;
}
function toggleTrashSelect(id,checked){if(checked)trashSelectedIds.add(id);else trashSelectedIds.delete(id);updateTrashActionBar();renderTrashTable()}
function toggleAllTrash(checked){trashItems.forEach(i=>{if(checked)trashSelectedIds.add(i.id);else trashSelectedIds.delete(i.id)});updateTrashActionBar();renderTrashTable()}
function clearTrashSelection(){trashSelectedIds.clear();updateTrashActionBar();renderTrashTable()}
function updateTrashActionBar(){const bar=document.getElementById('trashActions');if(trashSelectedIds.size>0){bar.style.display='flex';document.getElementById('trashSelCount').textContent=trashSelectedIds.size}else{bar.style.display='none'}}
async function batchRestoreTrash(){
  if(!confirm(`Restore ${trashSelectedIds.size} sessions?`))return;
  for(const id of trashSelectedIds)await apiPost(`/api/restore/${id}`);
  const d=await api('/api/sessions?limit=5000');allSessions=d.sessions||[];
  trashSelectedIds.clear();trashItems=await api('/api/trash');renderTrashTable();updateTrashActionBar();toast(`Restored sessions`);
}
async function batchDeleteTrash(){
  if(!confirm(`Permanently delete ${trashSelectedIds.size} sessions? This cannot be undone.`))return;
  await apiPost('/api/batch/trash-delete',{ids:[...trashSelectedIds]});
  trashSelectedIds.clear();trashItems=await api('/api/trash');renderTrashTable();updateTrashActionBar();toast('Sessions permanently deleted');
}
async function restoreOne(id){
  await apiPost(`/api/restore/${id}`);
  const d=await api('/api/sessions?limit=5000');allSessions=d.sessions||[];
  showTrash();toast('Session restored');
}
async function deleteOne(id){
  if(!confirm('Permanently delete this session? This cannot be undone.'))return;
  await apiDel(`/api/trash/${id}`);
  showTrash();toast('Session permanently deleted');
}

// ── Message order toggle ──
async function toggleMsgOrder(){
  msgOrderReversed=!msgOrderReversed;
  document.getElementById('msgOrderBtn').textContent=msgOrderReversed?'Oldest first':'Newest first';
  // If all messages loaded, just reverse the DOM
  if(allMessagesLoaded&&allDetailMessages.length){
    const ml=document.getElementById('msgList');
    const children=Array.from(ml.children);
    ml.innerHTML='';
    children.reverse().forEach(c=>ml.appendChild(c));
  }else{
    // Load all messages first, then show reversed
    await ensureAllMessagesLoaded();
    const ml=document.getElementById('msgList');
    const children=Array.from(ml.children);
    ml.innerHTML='';
    children.reverse().forEach(c=>ml.appendChild(c));
  }
  // Re-apply search highlights if active
  const query=document.getElementById('msgSearchInput')?.value?.trim();
  if(query)executeMsgSearch();
}

// ── In-conversation message search ──
function toggleMsgSearch(){
  const bar=document.getElementById('msgSearchBar');
  if(bar.style.display==='none'){bar.style.display='flex';const inp=document.getElementById('msgSearchInput');inp.focus();inp.select()}
  else closeMsgSearch();
}
function closeMsgSearch(){
  document.getElementById('msgSearchBar').style.display='none';
  document.getElementById('msgSearchInput').value='';
  document.getElementById('msgSearchInfo').textContent='';
  clearMsgHighlights();
  // Remove dim/hidden classes
  document.querySelectorAll('#msgList .msg').forEach(el=>{el.classList.remove('msg-dimmed','msg-hidden')});
  searchMatches=[];currentMatchIdx=-1;
}
async function ensureAllMessagesLoaded(){
  if(allMessagesLoaded||!currentDetailId)return;
  const ml=document.getElementById('msgList');
  // First fetch to get total
  const first=await api(`/api/sessions/${currentDetailId}/messages?offset=0&limit=100`);
  allDetailMessages=first.messages||[];
  const total=first.total||allDetailMessages.length;
  if(total>100){
    // Fetch remaining in parallel batches
    const fetches=[];
    for(let off=100;off<total;off+=100){
      fetches.push(api(`/api/sessions/${currentDetailId}/messages?offset=${off}&limit=100`));
    }
    const results=await Promise.all(fetches);
    for(const r of results){allDetailMessages=allDetailMessages.concat(r.messages||[])}
  }
  allMessagesLoaded=true;
  // Re-render all messages
  ml.innerHTML=allDetailMessages.map(m=>renderSingleMessage(m)).join('');
  document.getElementById('msgPag').innerHTML='';
}
function debounceMsgSearch(){
  clearTimeout(msgSearchTimer);
  msgSearchTimer=setTimeout(()=>executeMsgSearch(),200);
}
async function executeMsgSearch(){
  const query=document.getElementById('msgSearchInput').value.trim();
  const info=document.getElementById('msgSearchInfo');
  if(!query){clearMsgHighlights();info.textContent='';document.querySelectorAll('#msgList .msg').forEach(el=>{el.classList.remove('msg-dimmed','msg-hidden')});searchMatches=[];currentMatchIdx=-1;return}
  // Ensure all messages are loaded
  await ensureAllMessagesLoaded();
  // Clear previous highlights
  clearMsgHighlights();
  // Walk DOM and highlight matches
  searchMatches=[];
  const msgEls=document.querySelectorAll('#msgList .msg');
  msgEls.forEach(msgEl=>{
    const contentEl=msgEl.querySelector('.msg-content');
    if(!contentEl)return;
    const found=highlightTextNodes(contentEl,query);
    if(found){msgEl.classList.remove('msg-dimmed','msg-hidden')}
    else{
      if(msgSearchMode==='matches')msgEl.classList.add('msg-hidden');
      else msgEl.classList.add('msg-dimmed');
      msgEl.classList.remove(msgSearchMode==='matches'?'msg-dimmed':'msg-hidden');
    }
  });
  // Collect all marks
  searchMatches=Array.from(document.querySelectorAll('#msgList .search-hl'));
  if(searchMatches.length>0){currentMatchIdx=0;activateMatch();info.textContent=`1 / ${searchMatches.length}`}
  else{currentMatchIdx=-1;info.textContent='0 results'}
}
function highlightTextNodes(root,query){
  const lowerQ=query.toLowerCase();
  const walker=document.createTreeWalker(root,NodeFilter.SHOW_TEXT,null);
  const textNodes=[];
  while(walker.nextNode())textNodes.push(walker.currentNode);
  let found=false;
  for(const node of textNodes){
    const text=node.textContent;
    const lower=text.toLowerCase();
    let idx=lower.indexOf(lowerQ);
    if(idx===-1)continue;
    found=true;
    const frag=document.createDocumentFragment();
    let last=0;
    while(idx!==-1){
      if(idx>last)frag.appendChild(document.createTextNode(text.slice(last,idx)));
      const mark=document.createElement('mark');
      mark.className='search-hl';
      mark.textContent=text.slice(idx,idx+query.length);
      frag.appendChild(mark);
      last=idx+query.length;
      idx=lower.indexOf(lowerQ,last);
    }
    if(last<text.length)frag.appendChild(document.createTextNode(text.slice(last)));
    node.parentNode.replaceChild(frag,node);
  }
  return found;
}
function clearMsgHighlights(){
  document.querySelectorAll('#msgList .search-hl').forEach(mark=>{
    const parent=mark.parentNode;
    parent.replaceChild(document.createTextNode(mark.textContent),mark);
    parent.normalize();
  });
}
function activateMatch(){
  // Remove active class from all
  searchMatches.forEach(m=>m.classList.remove('search-hl-active'));
  if(currentMatchIdx>=0&&currentMatchIdx<searchMatches.length){
    const m=searchMatches[currentMatchIdx];
    m.classList.add('search-hl-active');
    m.scrollIntoView({block:'center',behavior:'smooth'});
    document.getElementById('msgSearchInfo').textContent=`${currentMatchIdx+1} / ${searchMatches.length}`;
  }
}
function msgSearchNext(){
  if(searchMatches.length===0)return;
  currentMatchIdx=(currentMatchIdx+1)%searchMatches.length;
  activateMatch();
}
function msgSearchPrev(){
  if(searchMatches.length===0)return;
  currentMatchIdx=(currentMatchIdx-1+searchMatches.length)%searchMatches.length;
  activateMatch();
}
function toggleMsgSearchMode(){
  msgSearchMode=msgSearchMode==='all'?'matches':'all';
  document.getElementById('msgSearchModeBtn').textContent=msgSearchMode==='all'?'All':'Matches';
  // Re-apply dim/hidden
  const query=document.getElementById('msgSearchInput').value.trim();
  if(!query)return;
  document.querySelectorAll('#msgList .msg').forEach(msgEl=>{
    const hasMatch=msgEl.querySelector('.search-hl');
    msgEl.classList.remove('msg-dimmed','msg-hidden');
    if(!hasMatch){
      if(msgSearchMode==='matches')msgEl.classList.add('msg-hidden');
      else msgEl.classList.add('msg-dimmed');
    }
  });
}
function msgSearchKeydown(e){
  if(e.key==='Enter'){e.preventDefault();if(e.shiftKey)msgSearchPrev();else msgSearchNext()}
  if(e.key==='Escape'){e.preventDefault();closeMsgSearch()}
}

// ── Global search ──
function doGlobalSearch(){
  const q=document.getElementById('globalSearch').value;
  if(!q)return;
  currentTab='all';
  document.getElementById('filterInput').value=q;
  showList();
}

// ── Keybinding system ──
const DEFAULT_KEYBINDINGS={
  filter:{label:'Filter sessions',key:'k',mod:true},
  globalSearch:{label:'Global search',key:'Enter',mod:true},
  dashboard:{label:'Go to dashboard',key:'g',mod:false},
  navDown:{label:'Navigate down',key:'j',mod:false},
  navUp:{label:'Navigate up',key:'k',mod:false},
  openSession:{label:'Open session',key:'Enter',mod:false},
  back:{label:'Go back / Close',key:'Escape',mod:false},
  msgSearch:{label:'Search in conversation',key:'f',mod:true},
  favorite:{label:'Toggle favorite',key:'f',mod:false},
  trash:{label:'Trash selected',key:'t',mod:false},
  sort:{label:'Change sort',key:'s',mod:false},
  streamer:{label:'Toggle streamer mode',key:'.',mod:false},
  help:{label:'Show help',key:'?',mod:false}
};
function getKeybindings(){
  try{const s=localStorage.getItem('csesh-keybindings');if(s){const p=JSON.parse(s);return{...DEFAULT_KEYBINDINGS,...p}}}catch{}
  return{...DEFAULT_KEYBINDINGS};
}
function saveKeybindings(kb){localStorage.setItem('csesh-keybindings',JSON.stringify(kb))}
function resetKeybindings(){localStorage.removeItem('csesh-keybindings');renderKbHelp();toast('Shortcuts reset to defaults')}
function keyLabel(binding){
  const parts=[];
  if(binding.mod)parts.push(navigator.platform.includes('Mac')?'⌘':'Ctrl');
  let k=binding.key;
  if(k==='Escape')k='Esc';
  if(k===' ')k='Space';
  if(k.length===1)k=k.toUpperCase();
  parts.push(k);
  return parts;
}
function renderKbHelp(){
  const kb=getKeybindings();
  const rows=document.getElementById('kbRows');
  if(!rows)return;
  rows.innerHTML=Object.entries(kb).map(([id,b])=>{
    const keys=keyLabel(b).map(k=>`<span class="kb-key">${k}</span>`).join(' ');
    return`<div class="kb-row"><span>${b.label}</span><span class="kb-edit" data-action="${id}" onclick="startRebind('${id}')" title="Click to rebind">${keys}</span></div>`;
  }).join('');
}
let rebindingAction=null;
function startRebind(action){
  if(rebindingAction)cancelRebind();
  rebindingAction=action;
  const el=document.querySelector(`.kb-edit[data-action="${action}"]`);
  if(el){el.classList.add('recording');el.innerHTML='<span class="kb-key" style="color:var(--accent)">Press a key...</span>'}
  document.addEventListener('keydown',captureRebind,true);
}
function captureRebind(e){
  e.preventDefault();e.stopImmediatePropagation();
  if(e.key==='Escape'){cancelRebind();return}
  // Ignore bare modifier keys
  if(['Shift','Control','Alt','Meta'].includes(e.key))return;
  const kb=getKeybindings();
  kb[rebindingAction]={...kb[rebindingAction],key:e.key,mod:e.metaKey||e.ctrlKey};
  saveKeybindings(kb);
  document.removeEventListener('keydown',captureRebind,true);
  rebindingAction=null;
  renderKbHelp();
  toast('Shortcut updated');
}
function cancelRebind(){
  document.removeEventListener('keydown',captureRebind,true);
  rebindingAction=null;
  renderKbHelp();
}
function matchesBinding(e,actionId){
  const kb=getKeybindings();
  const b=kb[actionId];
  if(!b)return false;
  if(b.mod&&!(e.metaKey||e.ctrlKey))return false;
  if(!b.mod&&(e.metaKey||e.ctrlKey))return false;
  return e.key===b.key||e.key===b.key.toUpperCase()||e.key===b.key.toLowerCase();
}

// ── Cmd+F capture (must be in capture phase to beat the browser) ──
document.addEventListener('keydown',e=>{
  if(matchesBinding(e,'msgSearch')&&document.getElementById('detail').style.display!=='none'){e.preventDefault();e.stopImmediatePropagation();toggleMsgSearch()}
},true);

// ── Keyboard shortcuts ──
document.addEventListener('keydown',e=>{
  // Modifier-based shortcuts (work from anywhere, including inputs)
  if(matchesBinding(e,'filter')){e.preventDefault();e.stopPropagation();const lv=document.getElementById('listView');if(!lv||lv.style.display==='none'){showList()}setTimeout(()=>{const inp=document.getElementById('filterInput');if(inp){inp.focus();inp.select()}},60);return}
  if(matchesBinding(e,'globalSearch')){e.preventDefault();e.stopPropagation();const gs=document.getElementById('globalSearch');if(gs){gs.focus();if(gs.value)doGlobalSearch()}else{showList()}return}
  // Escape — close search bar, modals, or go back (works from inputs too)
  if(matchesBinding(e,'back')){
    document.getElementById('kbHelp').style.display='none';
    document.getElementById('infoModal').style.display='none';
    if(document.getElementById('msgSearchBar')?.style.display!=='none'&&document.getElementById('detail').style.display!=='none'){closeMsgSearch();return}
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'){e.target.blur();return}
    if(document.getElementById('detail').style.display!=='none')goBack();
    return;
  }
  // Skip remaining shortcuts if typing in a form field
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT')return;
  const listVisible=document.getElementById('listView').style.display!=='none';
  if(matchesBinding(e,'dashboard')){e.preventDefault();showOverview()}
  else if(matchesBinding(e,'help')){e.preventDefault();renderKbHelp();document.getElementById('kbHelp').style.display='flex'}
  else if(matchesBinding(e,'streamer')){e.preventDefault();toggleStreamer()}
  else if(matchesBinding(e,'navDown')&&listVisible){e.preventDefault();if(focusIdx<0)focusIdx=0;else focusIdx=Math.min(focusIdx+1,getFiltered().length-1);highlightRow()}
  else if(matchesBinding(e,'navUp')&&listVisible&&!e.metaKey&&!e.ctrlKey){e.preventDefault();if(focusIdx<0)focusIdx=0;else focusIdx=Math.max(focusIdx-1,0);highlightRow()}
  else if(matchesBinding(e,'openSession')&&listVisible&&focusIdx>=0){const f=getFiltered();if(f[focusIdx])showDetail(f[focusIdx].id)}
  else if(matchesBinding(e,'favorite')&&listVisible&&focusIdx>=0){const f=getFiltered();if(f[focusIdx]){const sid=f[focusIdx].id;apiPost(`/api/sessions/${sid}/favorite`).then(r=>{const s=allSessions.find(x=>x.id===sid);if(s)s.favorite=r.favorite;renderTable();toast(r.favorite?'Added to favorites':'Removed from favorites')})}}
  else if(matchesBinding(e,'trash')&&listVisible){if(selectedIds.size>0)batchTrash()}
  else if(matchesBinding(e,'sort')&&listVisible){e.preventDefault();document.getElementById('sortSelect')?.focus()}
});
function highlightRow(){
  const localIdx=focusIdx-currentPage*PAGE;
  document.querySelectorAll('#tableBody tr').forEach((tr,i)=>{tr.classList.toggle('focused',i===localIdx)});
  const row=document.querySelector(`#tableBody tr:nth-child(${localIdx+1})`);
  if(row)row.scrollIntoView({block:'nearest'});
}

// ── Sidebar collapse ──
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  const collapsed=sb.classList.toggle('collapsed');
  document.getElementById('sbToggle').textContent=collapsed?'▶':'◀';
  localStorage.setItem('csesh-sidebar',collapsed?'1':'');
}
if(localStorage.getItem('csesh-sidebar')){
  document.getElementById('sidebar').classList.add('collapsed');
  document.getElementById('sbToggle').textContent='▶';
}

// ── Streamer mode ──
function toggleStreamer(){
  const on=document.body.classList.toggle('streamer-mode');
  localStorage.setItem('csesh-streamer',on?'1':'');
  updateSidebar();
  toast(on?'Streamer mode on — sensitive info blurred':'Streamer mode off');
}
if(localStorage.getItem('csesh-streamer'))document.body.classList.add('streamer-mode');

// ── Weekly cost comparison ──
function getWeeklyCostComparison(){
  const now=new Date();
  const thisWeekStart=new Date(now);thisWeekStart.setDate(now.getDate()-now.getDay());thisWeekStart.setHours(0,0,0,0);
  const lastWeekStart=new Date(thisWeekStart);lastWeekStart.setDate(lastWeekStart.getDate()-7);
  let thisWeek=0,lastWeek=0;
  allSessions.forEach(s=>{
    if(!s.lastTimestamp||!s.estimatedCost)return;
    const d=new Date(s.lastTimestamp);
    if(d>=thisWeekStart)thisWeek+=s.estimatedCost;
    else if(d>=lastWeekStart&&d<thisWeekStart)lastWeek+=s.estimatedCost;
  });
  if(lastWeek===0)return thisWeek>0?100:null;
  return((thisWeek-lastWeek)/lastWeek)*100;
}

// ── Activity heatmap ──
function renderHeatmap(){
  const grid=document.getElementById('heatmapGrid');
  const labels=document.getElementById('heatmapLabels');
  const months=document.getElementById('heatmapMonths');
  const legend=document.getElementById('heatmapLegend');
  if(!grid)return;

  // Build session counts by date
  const counts={};
  allSessions.forEach(s=>{
    if(!s.lastTimestamp)return;
    const d=new Date(s.lastTimestamp).toISOString().slice(0,10);
    counts[d]=(counts[d]||0)+1;
  });

  // Calculate date range: last 365 days, start on a Sunday
  const today=new Date();today.setHours(0,0,0,0);
  const start=new Date(today);start.setDate(start.getDate()-364);
  // Align start to Sunday
  while(start.getDay()!==0)start.setDate(start.getDate()-1);

  const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  // Day labels (only Mon, Wed, Fri)
  labels.innerHTML=dayNames.map((n,i)=>`<div class="heatmap-day-label">${i%2===1?n:''}</div>`).join('');

  // Build weeks
  const weeks=[];
  const current=new Date(start);
  let week=[];
  while(current<=today){
    week.push(new Date(current));
    if(week.length===7){weeks.push(week);week=[];}
    current.setDate(current.getDate()+1);
  }
  if(week.length>0){
    // Pad the last week with nulls
    while(week.length<7)week.push(null);
    weeks.push(week);
  }

  // Month labels
  const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let monthHtml='';
  let lastMonth=-1;
  weeks.forEach((w,wi)=>{
    const d=w.find(x=>x!==null);
    if(d){
      const m=d.getMonth();
      if(m!==lastMonth){
        // Calculate width: each column is 13px (11px + 2px gap)
        monthHtml+=`<span class="heatmap-month-label" style="margin-left:${wi===0?0:0}px">${monthNames[m]}</span>`;
        lastMonth=m;
      }
    }
  });
  months.innerHTML='';
  // Build month labels with proper positioning
  const monthPositions=[];
  lastMonth=-1;
  weeks.forEach((w,wi)=>{
    const d=w.find(x=>x!==null);
    if(d){
      const m=d.getMonth();
      if(m!==lastMonth){
        monthPositions.push({month:monthNames[m],col:wi});
        lastMonth=m;
      }
    }
  });
  months.innerHTML=monthPositions.map((mp,i)=>{
    const nextCol=i<monthPositions.length-1?monthPositions[i+1].col:weeks.length;
    const span=nextCol-mp.col;
    return`<span class="heatmap-month-label" style="width:${span*13}px">${mp.month}</span>`;
  }).join('');

  // Build grid
  grid.innerHTML=weeks.map((w,wi)=>{
    return'<div class="heatmap-col">'+w.map(d=>{
      if(!d)return'<div class="heatmap-cell"></div>';
      const key=d.toISOString().slice(0,10);
      const c=counts[key]||0;
      const level=c===0?0:c<=2?1:c<=5?2:c<=8?3:4;
      return`<div class="heatmap-cell" data-level="${level}" data-date="${key}" data-count="${c}"></div>`;
    }).join('')+'</div>';
  }).join('');

  // Legend
  legend.innerHTML='Less <div class="heatmap-legend-cell" style="background:var(--heatmap-0)"></div><div class="heatmap-legend-cell" style="background:var(--heatmap-1)"></div><div class="heatmap-legend-cell" style="background:var(--heatmap-2)"></div><div class="heatmap-legend-cell" style="background:var(--heatmap-3)"></div><div class="heatmap-legend-cell" style="background:var(--heatmap-4)"></div> More';

  // Tooltip events (only attach once)
  if(!grid._heatmapEvents){
    grid._heatmapEvents=true;
    let tooltip=null;
    grid.addEventListener('mouseover',e=>{
      const cell=e.target.closest('.heatmap-cell');
      if(!cell||!cell.dataset.date)return;
      if(!tooltip){tooltip=document.createElement('div');tooltip.className='heatmap-tooltip';document.body.appendChild(tooltip)}
      tooltip.textContent=`${cell.dataset.count} session${cell.dataset.count==='1'?'':'s'} on ${cell.dataset.date}`;
      tooltip.style.display='block';
    });
    grid.addEventListener('mousemove',e=>{
      if(tooltip){tooltip.style.left=e.clientX+12+'px';tooltip.style.top=e.clientY-28+'px'}
    });
    grid.addEventListener('mouseout',e=>{
      const cell=e.target.closest('.heatmap-cell');
      if(cell&&tooltip){tooltip.style.display='none'}
    });
  }
}

// ── Top Sessions widget ──
function setTsTab(tab){
  currentTsTab=tab;
  document.querySelectorAll('.ts-tab').forEach(b=>b.classList.toggle('active',b.textContent.toLowerCase().includes(tab==='active'?'active':tab==='heaviest'?'heaviest':'recent')));
  renderTopSessions();
}
function renderTopSessions(){
  const container=document.getElementById('tsCards');
  if(!container||!allSessions.length)return;
  let sorted=[...allSessions];
  let metaFn;
  if(currentTsTab==='active'){
    sorted.sort((a,b)=>(b.userMessageCount+b.assistantMessageCount)-(a.userMessageCount+a.assistantMessageCount));
    metaFn=s=>`${s.userMessageCount+s.assistantMessageCount} messages`;
  }else if(currentTsTab==='heaviest'){
    sorted.sort((a,b)=>(b.fileSizeBytes||0)-(a.fileSizeBytes||0));
    metaFn=s=>fmtBytes(s.fileSizeBytes||0);
  }else{
    sorted.sort((a,b)=>{if(!a.lastTimestamp)return 1;if(!b.lastTimestamp)return-1;return new Date(b.lastTimestamp)-new Date(a.lastTimestamp)});
    metaFn=s=>s.lastTimestamp?new Date(s.lastTimestamp).toLocaleDateString('en-CA'):'—';
  }
  const top5=sorted.slice(0,6);
  container.innerHTML=top5.map(s=>{
    const title=esc((s.displayTitle||s.title||'Untitled').slice(0,40));
    const proj=esc((s.shortProject||'').slice(0,20));
    const metric=metaFn(s);
    return`<div class="ts-card" onclick="showDetail('${s.id}')"><div class="ts-card-title">${title}</div><div class="ts-card-meta"><span>${proj}</span><span>&middot;</span><span>${metric}</span></div></div>`;
  }).join('')||'<div style="color:var(--text-3);font-size:.78rem;padding:8px">No sessions</div>';
  // Update tab active states
  document.querySelectorAll('.ts-tab').forEach(b=>{
    const text=b.textContent.toLowerCase();
    b.classList.toggle('active',(currentTsTab==='recent'&&text==='recent')||(currentTsTab==='active'&&text.includes('active'))||(currentTsTab==='heaviest'&&text==='heaviest'));
  });
}

// ── Theme toggle ──
const themeStates=['auto','light','dark'];
let currentThemeIdx=0;
function getThemePref(){return localStorage.getItem('csesh-theme')||'auto'}
function setThemePref(pref){localStorage.setItem('csesh-theme',pref);applyTheme()}
function applyTheme(){
  const pref=getThemePref();
  const html=document.documentElement;
  if(pref==='light'){html.setAttribute('data-theme','light')}
  else if(pref==='dark'){html.removeAttribute('data-theme')}
  else{
    // auto: detect system preference
    const preferLight=window.matchMedia('(prefers-color-scheme: light)').matches;
    if(preferLight){html.setAttribute('data-theme','light')}else{html.removeAttribute('data-theme')}
  }
  updateThemeButton();
  // Re-render charts if they exist (colors need updating)
  if(stats&&document.getElementById('overview').style.display!=='none'){renderCharts()}
}
function cycleTheme(){
  const pref=getThemePref();
  const idx=themeStates.indexOf(pref);
  const next=themeStates[(idx+1)%themeStates.length];
  setThemePref(next);
}
function updateThemeButton(){
  const btn=document.getElementById('themeToggleBtn');
  if(!btn)return;
  const pref=getThemePref();
  const isLight=document.documentElement.getAttribute('data-theme')==='light';
  const icons={auto:'&#9681;',light:'&#9728;',dark:'&#9790;'};
  btn.innerHTML=icons[pref]||icons.auto;
  btn.title='Theme: '+pref+' (click to cycle)';
}
// Listen for system theme changes
window.matchMedia('(prefers-color-scheme: light)').addEventListener('change',()=>{
  if(getThemePref()==='auto')applyTheme();
});
// Apply theme immediately
applyTheme();
renderKbHelp();

init();
</script>
</body>
</html>
